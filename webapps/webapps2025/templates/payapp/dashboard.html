{% extends "payapp/base.html" %}

{% block title %}Dashboard · VyoPay{% endblock %}

{% block content %}
<section class="mb-6">
  <h1 class="text-2xl md:text-[28px] font-semibold tracking-tight mb-1">Dashboard</h1>
  <p class="text-xs text-slate-400 max-w-xl">
    Monitor your VyoPay links, track payments, and manage activity in one place.
  </p>
</section>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <!-- Total volume -->
  <div class="glass hover-card rounded-xl border border-slate-800 p-4 relative overflow-hidden">
    <div class="absolute top-0 inset-x-0 h-[2px] bg-gradient-to-r from-cyan-500/60 via-blue-500/30 to-transparent"></div>
    <p class="text-[11px] tracking-wide text-slate-400 uppercase mb-1">Total volume</p>
    <p class="text-2xl font-semibold">
      {{ summary.total_amount|default:"0.00" }} GBP
    </p>
    <p class="text-[11px] text-slate-500 mt-1">
      Combined value of all VyoPay requests.
    </p>
  </div>

  <!-- Collected -->
  <div class="glass hover-card rounded-xl border border-slate-800 p-4">
    <p class="text-[11px] tracking-wide text-slate-400 uppercase mb-1">Collected</p>
    <p class="text-2xl font-semibold text-emerald-400">
      {{ summary.total_paid|default:"0.00" }} GBP
    </p>
    <p class="text-[11px] text-slate-500 mt-1">
      Payments successfully completed.
    </p>
  </div>

  <!-- Links -->
  <div class="glass hover-card rounded-xl border border-slate-800 p-4">
    <p class="text-[11px] tracking-wide text-slate-400 uppercase mb-1">Payment links</p>
    <p class="text-2xl font-semibold text-sky-400">
      {{ summary.count|default:"0" }}
    </p>
    <p class="text-[11px] text-slate-500 mt-1">
      Active and historical VyoPay links.
    </p>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
  <!-- Chart -->
  <div class="lg:col-span-2 glass rounded-2xl border border-slate-800 p-4 hover-card">
    <div class="flex items-center justify-between mb-2">
      <div>
        <p class="text-xs font-semibold text-slate-200">Last 7 days</p>
        <p class="text-[11px] text-slate-500">Views vs successful payments</p>
      </div>
    </div>
    <div class="h-56">
      <canvas id="vyopay-traffic-chart"></canvas>
    </div>
  </div>

  <!-- Mini stats box (optional, placeholder for future analytics) -->
  <div class="space-y-3">
    <div class="glass rounded-xl border border-slate-800 p-4 hover-card">
      <p class="text-[11px] text-slate-400 uppercase mb-1">Overview</p>
      <p class="text-xs text-slate-400">
        Add more analytics soon – conversion rate, average payment, top currencies, etc.
      </p>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Recent payment links -->
  <div class="glass rounded-2xl border border-slate-800 hover-card">
    <div class="flex items-center justify-between px-4 pt-3 pb-2 border-b border-slate-800/70">
      <p class="text-xs font-semibold text-slate-200">Recent payment links</p>
      <p class="text-[11px] text-slate-500">Latest 10</p>
    </div>
    <div class="divide-y divide-slate-800/80">
      {% if payment_requests %}
        {% for payment in payment_requests %}
          <a href="{% url 'payapp:payment_link_detail' payment.short_code %}"
             class="flex items-center justify-between px-4 py-3 text-sm hover:bg-slate-900/70 transition">
            <div>
              <p class="text-[13px] font-medium">
                {{ payment.amount }} {{ payment.currency|upper }}
              </p>
              <p class="text-[11px] text-slate-500">
                {{ payment.description|default:"Untitled link" }}
              </p>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="text-[11px] font-mono text-slate-500">{{ payment.short_code }}</span>
              {% if payment.status == payment.STATUS_PAID %}
                <span class="px-2 py-0.5 rounded-full text-[10px] bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
                  PAID
                </span>
              {% elif payment.status == payment.STATUS_EXPIRED %}
                <span class="px-2 py-0.5 rounded-full text-[10px] bg-slate-700/60 text-slate-300 border border-slate-500/60">
                  EXPIRED
                </span>
              {% else %}
                <span class="px-2 py-0.5 rounded-full text-[10px] bg-amber-500/10 text-amber-300 border border-amber-500/40">
                  PENDING
                </span>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      {% else %}
        <p class="px-4 py-6 text-xs text-slate-500">
          No links yet. Create your first payment link to start collecting with VyoPay.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- Recent transactions -->
  <div class="glass rounded-2xl border border-slate-800 hover-card">
    <div class="flex items-center justify-between px-4 pt-3 pb-2 border-b border-slate-800/70">
      <p class="text-xs font-semibold text-slate-200">Recent transactions</p>
      <p class="text-[11px] text-slate-500">Latest 20</p>
    </div>
    <div class="divide-y divide-slate-800/80">
      {% if transactions %}
        {% for tx in transactions %}
          <div class="flex items-center justify-between px-4 py-3 text-sm">
            <div>
              <p class="text-[13px] font-medium">
                {{ tx.amount }} {{ tx.currency }}
              </p>
              <p class="text-[11px] text-slate-500">
                {{ tx.payment_request.description|default:"Payment" }}
              </p>
            </div>
            <div class="text-right">
              <p class="text-[11px] text-slate-500">
                {{ tx.created_at|date:"d M, H:i" }}
              </p>
              <p class="text-[10px] font-mono text-slate-500">
                {{ tx.payment_request.short_code }}
              </p>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="px-4 py-6 text-xs text-slate-500">
          No transactions yet. Once payments complete, they’ll appear here.
        </p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = JSON.parse('{{ chart_labels|escapejs }}');
  const viewsData = JSON.parse('{{ chart_views|escapejs }}');
  const paidData = JSON.parse('{{ chart_paid|escapejs }}');

  const ctx = document.getElementById('vyopay-traffic-chart');
  if (ctx) {
    new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Views',
            data: viewsData,
            tension: 0.35,
            borderWidth: 2,
            borderColor: 'rgb(56, 189, 248)',
            pointRadius: 2,
            pointBackgroundColor: 'rgb(56, 189, 248)',
          },
          {
            label: 'Payments',
            data: paidData,
            tension: 0.35,
            borderWidth: 2,
            borderColor: 'rgb(16, 185, 129)',
            pointRadius: 2,
            pointBackgroundColor: 'rgb(16, 185, 129)',
          }
        ]
      },
      options: {
        plugins: {
          legend: {
            labels: { color: '#cbd5f5', font: { size: 11 } }
          }
        },
        scales: {
          x: {
            ticks: { color: '#64748b', font: { size: 10 } },
            grid: { color: 'rgba(148, 163, 184, 0.15)' }
          },
          y: {
            ticks: { color: '#64748b', font: { size: 10 } },
            grid: { color: 'rgba(148, 163, 184, 0.15)' }
          }
        }
      }
    });
  }
</script>
{% endblock %}
